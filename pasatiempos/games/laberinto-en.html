<!DOCTYPE html>
<html lang="es">
<head>
<link rel="shortcut icon" href="img/favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Shandor Caves</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #121212;
      color: #f0f0f0;
    }

    h1 {
      margin-top: 1rem;
      color: #ffffff;
    }

    #maze {
      display: grid;
      touch-action: manipulation;
      border: 5px solid #888;
      box-sizing: content-box;
    }

    .cell {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: none;
      box-sizing: border-box;
    }

    .wall {
      background-color: #8B4513;
    }

    .path {
      background-color: #1e1e1e;
    }

    .marked {
      background-color: #ffeb3b;
    }

    .start {
      background-color: #f44336;
    }

    .end {
      background-color: #4caf50;
    }

    #controls {
      margin: 1rem;
    }

    button {
      padding: 0.5rem 1rem;
      margin: 0.2rem;
      font-size: 1rem;
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #444;
    }

    #message {
      font-size: 1.2rem;
      color: #00e676;
      margin-bottom: 1rem;
      height: 1.5rem;
    }

    @media (min-width: 600px) {
      #maze {
        width: 80vmin;
        height: 80vmin;
      }
    }

    @media (max-width: 599px) {
      #maze {
        width: 95vmin;
        height: 95vmin;
      }
    }
  </style>
</head>
<body>
  <h1>The Shandor Caves</h1>
  <br>Find the way to escape from Gozer
  <div id="controls">
    <button onclick="generateMaze()">New Path</button>
    <button onclick="clearPath()">Delete Path</button>
	<a href="../pasatiempos-en.html">
  <button>Back to Games</button>
</a>
  </div>
  <div id="message"></div>
  <audio id="victorySound" src="sonidos/011.mp3" preload="auto"></audio>
  <div id="maze"></div>

  <script>
    const rows = 15;
    const cols = 15;
    const mazeContainer = document.getElementById('maze');
    const messageContainer = document.getElementById('message');

    let maze = [];
    let isDrawing = false;
    let isCompleted = false;

    function generateMaze() {
      isCompleted = false;
      messageContainer.textContent = '';
      mazeContainer.innerHTML = '';
      mazeContainer.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
      mazeContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      maze = Array.from({ length: rows }, () => Array(cols).fill(1));

      function carve(x, y) {
        const dirs = [[0,1],[1,0],[0,-1],[-1,0]].sort(() => Math.random() - 0.5);
        for (const [dx, dy] of dirs) {
          const nx = x + dx * 2;
          const ny = y + dy * 2;
          if (nx >= 0 && nx < cols && ny >= 0 && ny < rows && maze[ny][nx] === 1) {
            maze[y + dy][x + dx] = 0;
            maze[ny][nx] = 0;
            carve(nx, ny);
          }
        }
      }

      maze[0][0] = 0;
      carve(0, 0);
      maze[0][0] = 2; // entrada
      maze[rows - 1][cols - 1] = 3; // salida

      drawMaze();
    }

    function drawMaze() {
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          const cell = document.createElement('div');
          cell.classList.add('cell');
          const value = maze[y][x];
          if (value === 1) cell.classList.add('wall');
          else if (value === 0) cell.classList.add('path');
          else if (value === 2) cell.classList.add('start');
          else if (value === 3) cell.classList.add('end');
          cell.dataset.x = x;
          cell.dataset.y = y;

          cell.addEventListener('mousedown', startDraw);
          cell.addEventListener('mouseover', drawIfDragging);
          cell.addEventListener('touchstart', startDraw, { passive: true });
          cell.addEventListener('touchmove', drawTouch, { passive: true });

          mazeContainer.appendChild(cell);
        }
      }

      document.body.addEventListener('mouseup', () => isDrawing = false);
      document.body.addEventListener('touchend', () => isDrawing = false);
    }

    function startDraw(e) {
      if (isCompleted) return;
      if (e.target.classList.contains('path')) {
        isDrawing = true;
        e.target.classList.add('marked');
        checkSolution();
      }
    }

    function drawIfDragging(e) {
      if (isCompleted) return;
      if (isDrawing && e.target.classList.contains('path')) {
        e.target.classList.add('marked');
        checkSolution();
      }
    }

    function drawTouch(e) {
      if (isCompleted) return;
      const touch = e.touches[0];
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      if (target && target.classList.contains('path')) {
        target.classList.add('marked');
        checkSolution();
      }
    }

    function clearPath() {
      document.querySelectorAll('.marked').forEach(cell => {
        cell.classList.remove('marked');
      });
      isCompleted = false;
      messageContainer.textContent = '';
      // Pausar y reiniciar el sonido si ya se estaba reproduciendo
      const victorySound = document.getElementById('victorySound');
      if (victorySound) {
        victorySound.pause();
        victorySound.currentTime = 0;
      }
    }

    function checkSolution() {
      const visited = new Set();
      const stack = [[0, 0]];
      const victorySound = document.getElementById('victorySound'); // Obtener el elemento de audio

      while (stack.length > 0) {
        const [x, y] = stack.pop();
        const key = `${x},${y}`;
        if (visited.has(key)) continue;
        visited.add(key);

        if (x === cols - 1 && y === rows - 1) {
          messageContainer.textContent = 'did you manage to escape!';
          isCompleted = true;
          if (victorySound) {
            victorySound.play(); // Reproducir el sonido
          }
          return;
        }

        const neighbors = [
          [x + 1, y],
          [x - 1, y],
          [x, y + 1],
          [x, y - 1]
        ];

        for (const [nx, ny] of neighbors) {
          if (nx >= 0 && ny >= 0 && nx < cols && ny < rows) {
            const cell = document.querySelector(`.cell[data-x="${nx}"][data-y="${ny}"]`);
            if (cell && (cell.classList.contains('marked') || cell.classList.contains('end'))) {
              stack.push([nx, ny]);
            }
          }
        }
      }

      messageContainer.textContent = '';
    }

    generateMaze();
  </script>
</body>
</html>