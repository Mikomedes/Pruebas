<!DOCTYPE html>
<html lang="es">
<link rel="shortcut icon" href="img/favicon.ico">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>¡Ayúdanos Moquete!</title>
  <style>
    html,body{
      margin:0;padding:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Arial;
    }
    /* Viewport */
    #viewport{
      width:100vw;height:100vh;overflow:hidden;position:relative;cursor:grab;
    }
    /* Contenedor centrado horizontalmente */
    #game-container{
      position:absolute;top:0;left:50%;transform:translateX(-50%);
      /* no tamaño fijo: el <img> define el tamaño real */
      transition: top 0.5s ease-in-out; /* TRANSICIÓN PARA EL DESPLAZAMIENTO SUAVE */
    }
    #board{
      width:100vw;height:auto;display:block;user-select:none;-webkit-user-drag:none;
    }

    /* fichas */
    .ficha{
      position:absolute;
      width:1.5vw;
      aspect-ratio:1;
      border-radius:50%;
      border:2px solid #fff;
      z-index:10;
      box-sizing:border-box;
      transform:translate(-50%,-50%); /* centrar en su punto */
      transition: all 0.5s ease-in-out; /* Animación para el movimiento suave */
    }
    /* Clase para la animación de 'levantar' la ficha */
    .ficha-levantada {
        transform: translate(calc(-50% - 15px), calc(-50% - 15px)) scale(1.4);
        z-index: 20;
    }

    /* botones de control (tirar, musica) */
    .controles {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 200;
        display: flex;
        flex-direction: row; /* Cambio a horizontal */
        gap: 10px;
        align-items: center; /* Alineación vertical */
    }
   .boton{
      padding:12px 20px;
      background:#444;
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:16px;
      font-weight: bold;
      transition: transform 0.3s ease, background 0.3s ease; /* para animación */
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }
    /* Estilos para el botón de música con icono */
    #botonMusica {
        font-size: 20px;
        padding: 10px 15px;
    }
    .boton.animando {
      transform: scale(1.1) rotate(-10deg);
    }
    .boton:disabled {
      background: #777;
      cursor: not-allowed;
      box-shadow: none;
    }
    .boton:hover:enabled {
        background: #555;
    }

    /* Mensajes y estado */
    #mensajes-juego {
      position: fixed;
      right: 20px;
      top: 100px;
      z-index: 200;
      background: #222;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      min-width: 200px;
      text-align: center;
      transition: opacity 0.5s ease-out, color 0.5s ease-out;
    }
    #dado-contenedor {
        position: fixed;
        right: 20px;
        top: 180px;
        width: 60px;
        height: 60px;
        z-index: 200;
        display: none;
        perspective: 1000px;
    }
    .dado {
        position: relative;
        width: 100%;
        height: 100%;
        transform-style: preserve-3d;
    }
    .dado-cara {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #fff;
        border-radius: 8px;
        font-size: 30px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        border: 2px solid #333;
    }
    .dado-cara-1 { transform: rotateY(0deg) translateZ(30px); }
    .dado-cara-2 { transform: rotateX(90deg) translateZ(30px); }
    .dado-cara-3 { transform: rotateY(90deg) translateZ(30px); }
    .dado-cara-4 { transform: rotateY(-90deg) translateZ(30px); }
    .dado-cara-5 { transform: rotateX(-90deg) translateZ(30px); }
    .dado-cara-6 { transform: rotateY(-180deg) translateZ(30px); }
    
    .girando {
        animation: dado-girando 1s infinite linear;
    }
    @keyframes dado-girando {
        0% { transform: rotateX(0) rotateY(0) rotateZ(0); }
        100% { transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg); }
    }
    .girando-final-1 { animation: girar-a-1 1s ease-out forwards; }
    .girando-final-2 { animation: girar-a-2 1s ease-out forwards; }
    .girando-final-3 { animation: girar-a-3 1s ease-out forwards; }
    .girando-final-4 { animation: girar-a-4 1s ease-out forwards; }
    .girando-final-5 { animation: girar-a-5 1s ease-out forwards; }
    .girando-final-6 { animation: girar-a-6 1s ease-out forwards; }
    
    @keyframes girar-a-1 { from {transform: rotateX(0) rotateY(0) rotateZ(0);} to {transform: rotateX(720deg) rotateY(720deg) rotateZ(720deg) rotateY(0deg) rotateX(0deg);} }
    @keyframes girar-a-2 { from {transform: rotateX(0) rotateY(0) rotateZ(0);} to {transform: rotateX(720deg) rotateY(720deg) rotateZ(720deg) rotateX(-90deg);} }
    @keyframes girar-a-3 { from {transform: rotateX(0) rotateY(0) rotateZ(0);} to {transform: rotateX(720deg) rotateY(720deg) rotateZ(720deg) rotateY(-90deg);} }
    @keyframes girar-a-4 { from {transform: rotateX(0) rotateY(0) rotateZ(0);} to {transform: rotateX(720deg) rotateY(720deg) rotateZ(720deg) rotateY(90deg);} }
    @keyframes girar-a-5 { from {transform: rotateX(0) rotateY(0) rotateZ(0);} to {transform: rotateX(720deg) rotateY(720deg) rotateZ(720deg) rotateX(90deg);} }
    @keyframes girar-a-6 { from {transform: rotateX(0) rotateY(0) rotateZ(0);} to {transform: rotateX(720deg) rotateY(720deg) rotateZ(720deg) rotateY(180deg);} }

    /* modales (menu / orden / final) */
    .modal{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:rgba(17,17,17,0.9);
      color:#fff;padding:25px 35px;border-radius:12px;z-index:300;text-align:center;
      box-shadow:0 10px 30px rgba(0,0,0,0.8);
      min-width:280px;
    }
    .modal h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: gold;
        text-shadow: 0 0 5px rgba(255,215,0,0.5);
    }
    .modal .modal-buttons {
        margin-top: 15px;
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    .modal button{
      padding:10px 20px;
      font-size:16px;
      font-weight: bold;
      cursor:pointer;
      border-radius:8px;
      border:none;
      background: linear-gradient(145deg, #444, #222);
      color: #fff;
      box-shadow: inset 0 1px 3px rgba(255,255,255,0.1), 0 5px 15px rgba(0,0,0,0.6);
      transition: all 0.2s ease;
    }
    .modal button:hover {
        background: linear-gradient(145deg, #555, #333);
        transform: translateY(-2px);
    }
    #ordenSalida .jugador-turno{margin:6px 0}
    /* animaciones */
    .brillo{animation:resplandor .5s alternate infinite;box-shadow:0 0 8px gold}
    @keyframes resplandor{from{box-shadow:0 0 8px gold}to{box-shadow:0 0 26px gold}}

    /* Nuevos resplandores para casillas */
    .casilla-resplandor {
        position: absolute;
        pointer-events: none;
        width: 3vw;
        height: 3vw;
        border-radius: 50%;
        z-index: 50;
        transform: translate(-50%,-50%);
        box-sizing: border-box;
    }
    .brillo-rojo {
        animation: resplandor-rojo 0.5s alternate infinite;
    }
    .brillo-verde {
        animation: resplandor-verde 0.5s alternate infinite;
    }
    .brillo-gozer {
        animation: resplandor-gozer 0.2s alternate infinite;
    }
    @keyframes resplandor-rojo {
        from { box-shadow: 0 0 10px 2px red; }
        to { box-shadow: 0 0 20px 8px red; }
    }
    @keyframes resplandor-verde {
        from { box-shadow: 0 0 10px 2px green; }
        to { box-shadow: 0 0 20px 8px green; }
    }
    @keyframes resplandor-gozer {
        from { box-shadow: 0 0 10px 2px #4a9fe8; }
        to { box-shadow: 0 0 30px 10px #4a9fe8; }
    }
    
    .texto-flotante{position:absolute;color:gold;font-weight:bold;pointer-events:none;text-shadow:1px 1px 4px rgba(0,0,0,0.7);z-index:400;transform:translate(-50%,-100%);animation:flotar 1.6s ease-out forwards}
    @keyframes flotar{0%{opacity:1;transform:translate(-50%,0)}100%{opacity:0;transform:translate(-50%,-50px)}}
    
    /* NUEVO: Estilos para el texto de acción especial con recuadro */
    .texto-especial {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-size: 3vw; /* Más grande que el mensaje flotante */
        font-weight: bold;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.5);
        pointer-events: none;
        z-index: 500;
        opacity: 0;
        animation: texto-accion-anim 2.5s ease-out forwards;
        background-color: rgba(0,0,0,0.7); /* Fondo semi-transparente */
        padding: 1vw 2vw; /* Relleno */
        border-radius: 1vw; /* Esquinas redondeadas */
        white-space: nowrap; /* Para que el texto no se rompa */
    }
    @keyframes texto-accion-anim {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
    }

  </style>
</head>
<body>
  
  <audio id="audio-musica-inicio" src="sonidos/000.mp3" preload="auto" loop></audio>
  <audio id="audio-subida-1" src="sonidos/001.mpd3" preload="auto"></audio>
  <audio id="audio-subida-2" src="sonidos/002.mp3" preload="auto"></audio>
  <audio id="audio-bajada-1" src="sonidos/003.mp3" preload="auto"></audio>
  <audio id="audio-bajada-2" src="sonidos/004.mp3" preload="auto"></audio>
  <audio id="audio-gozer" src="sonidos/005.mp3" preload="auto"></audio>
  <audio id="audio-dado-6" src="sonidos/006.mp3" preload="auto"></audio>
  <audio id="audio-llegada-meta" src="sonidos/007.mp3" preload="auto"></audio>
  <audio id="audio-tirada" src="sonidos/008.mp3" preload="auto"></audio>


  <div id="startMenu" class="modal">
    <h3>¡Ayúdanos Moquete!</h3>
    <div class="modal-buttons">
      <button onclick="iniciarMenuJuego()">¡Empezar a jugar!</button>
    </div>
  </div>

  <div id="menu" class="modal" style="display:none;">
    <h3>Selecciona número de jugadores</h3>
    <div class="modal-buttons">
      <button onclick="prepararOrden(1)">1 Jugador</button>
      <button onclick="prepararOrden(2)">2 Jugadores</button>
      <button onclick="prepararOrden(3)">3 Jugadores</button>
      <button onclick="prepararOrden(4)">4 Jugadores</button>
    </div>
  </div>

  <div id="ordenSalida" class="modal" style="display:none;">
    <div id="textoOrden"></div>
    <div id="valeWrap" class="modal-buttons" style="display:none;">
      <button onclick="confirmarOrden()">VALE</button>
    </div>
  </div>

  <div id="finalModal" class="modal" style="display:none;"></div>

  <div class="controles">
    <button id="botonMusica" class="boton" onclick="toggleMusica()"></button>
    <button id="botonTirar" class="boton" style="display:none;" onclick="simularTirada()">Tirar dado</button>
  </div>

  <div id="mensajes-juego" style="display:none;"></div>
  
  <div id="dado-contenedor">
    <div id="dado" class="dado">
      <div class="dado-cara dado-cara-1">1</div>
      <div class="dado-cara dado-cara-2">2</div>
      <div class="dado-cara dado-cara-3">3</div>
      <div class="dado-cara dado-cara-4">4</div>
      <div class="dado-cara dado-cara-5">5</div>
      <div class="dado-cara dado-cara-6">6</div>
    </div>
  </div>

  <div id="viewport">
    <div id="game-container">
      <img id="board" src="img/tablero.png" alt="Tablero">
    </div>
  </div>

<script>
/* --------- Datos y estado ---------- */
const diseñoOriginal = { width: 5315, height: 3780 };
const colores = ["#e84a4a","#4a9fe8","#4ae89f","#e8d14a"]; // rojo, azul, verde, amarillo
const nombresColores = {
  "#e84a4a": "Rojo",
  "#4a9fe8": "Azul",
  "#4ae89f": "Verde",
  "#e8d14a": "Amarillo"
};
const coords = [
  [630,3413],[618,2884],[672,2566],[870,2313],[1165,2229],[1441,2355],[1669,2590],[1885,2860],[2070,3100],[2324,3317],
  [2630,3417],[2936,3359],[3213,3191],[3345,2890],[3291,2572],[3080,2325],[2810,2151],[2522,2055],[2216,1983],[1899,1899],
  [1580,1832],[1273,1790],[954,1700],[660,1532],[504,1280],[450,973],[546,667],[764,431],[1069,312],[1387,300],
  [1705,348],[2005,426],[2294,552],[2576,739],[2816,931],[3026,1183],[3201,1442],[3375,1730],[3513,2019],[3651,2295],
  [3783,2584],[3927,2884],[4101,3151],[4348,3353],[4660,3370],[4936,3220],[5050,2914],[5008,2608],[4882,2301],[4690,2025],
  [4492,1790],[4258,1586],[3879,1280]
];
const especiales = {
  2: {destino:23, tipo:'avance'},
  19: {destino:32, tipo:'avance'},
  18: {destino:6, tipo:'retroceso'},
  11: {destino:27, tipo:'avance'},
  27: {destino:36, tipo:'avance'},
  36: {destino:49, tipo:'avance'},
  48: {destino:40, tipo:'retroceso'},
  51: {destino:0, tipo:'gozer'}
};


let jugadores = [];        // lista de objetos { id, ficha(element), posicion, activo, seisConsecutivos }
let ordenJugadores = [];   // array de ids en orden de juego
let turnoActual = 0;
let llegados = [];         // ids en orden de llegada
let mensajeTimer = null; // Para limpiar el temporizador del mensaje

/* Drag vertical */
let isDragging = false, startY = 0, currentTop = 0;
const gameContainer = document.getElementById("game-container");
const viewport = document.getElementById("viewport");
const board = document.getElementById("board");
const startMenuDiv = document.getElementById("startMenu");
const menuDiv = document.getElementById("menu");
const ordenSalidaDiv = document.getElementById("ordenSalida");
const textoOrdenDiv = document.getElementById("textoOrden");
const valeWrap = document.getElementById("valeWrap");
const finalModal = document.getElementById("finalModal");
const botonTirar = document.getElementById("botonTirar");
const botonMusica = document.getElementById("botonMusica");
const mensajesJuego = document.getElementById("mensajes-juego");
const dadoContenedor = document.getElementById("dado-contenedor");
const dadoElemento = document.getElementById("dado");

/* Variables de audio */
const audioMusicaInicio = document.getElementById('audio-musica-inicio');
const audioTiradaDado = document.getElementById('audio-tirada');
const audioSubida1 = document.getElementById('audio-subida-1');
const audioSubida2 = document.getElementById('audio-subida-2');
const audioBajada1 = document.getElementById('audio-bajada-1');
const audioBajada2 = document.getElementById('audio-bajada-2');
const audioGozer = document.getElementById('audio-gozer');
const audioDado6 = document.getElementById('audio-dado-6');
const audioLlegadaMeta = document.getElementById('audio-llegada-meta');

// Nuevo: Estado de la música, se inicializa con lo guardado en localStorage o a true por defecto
let isMusicEnabled = localStorage.getItem('musicEnabled') === 'false' ? false : true;


function playSound(audioElement) {
    if (audioElement) {
        audioElement.currentTime = 0; // Reiniciar el audio si ya está en reproducción
        audioElement.play().catch(e => console.error("Error al reproducir audio:", e));
    }
}

function playRandomSound(audioElements) {
    const randomIndex = Math.floor(Math.random() * audioElements.length);
    playSound(audioElements[randomIndex]);
}

/* ------------ Drag vertical (solo eje Y) ------------- */
viewport.addEventListener('mousedown', (e)=>{ isDragging = true; startY = e.clientY; viewport.style.cursor = 'grabbing'; });
viewport.addEventListener('mouseup', ()=>{ isDragging = false; viewport.style.cursor = 'grab'; });
viewport.addEventListener('mouseleave', ()=>{ isDragging = false; viewport.style.cursor = 'grab'; });
viewport.addEventListener('mousemove', (e)=>{
  if (!isDragging) return;
  const dy = e.clientY - startY;
  startY = e.clientY;
  currentTop += dy;
  clampAndApplyTop();
});

function clampAndApplyTop(){
  const b = document.getElementById('board');
  const maxTop = 0;
  const minTop = viewport.clientHeight - b.clientHeight;
  if (minTop > 0) { // tablero más pequeño que viewport verticalmente
    currentTop = 0;
  } else {
    currentTop = Math.min(maxTop, Math.max(minTop, currentTop));
  }
  gameContainer.style.top = currentTop + 'px';
}

/* NUEVA FUNCION: Iniciar la musica y mostrar el menu */
function iniciarMenuJuego() {
  if (isMusicEnabled) {
    playSound(audioMusicaInicio);
  }
  startMenuDiv.style.display = 'none';
  menuDiv.style.display = 'block';
}

// Nuevo: Funcion para alternar la musica
function toggleMusica() {
    isMusicEnabled = !isMusicEnabled;
    localStorage.setItem('musicEnabled', isMusicEnabled);
    if (isMusicEnabled) {
        botonMusica.innerHTML = '&#128266;'; // Icono de altavoz ON
        playSound(audioMusicaInicio);
    } else {
        botonMusica.innerHTML = '&#128263;'; // Icono de altavoz OFF
        audioMusicaInicio.pause();
    }
}

/* ------------ Orden inicial con desempates robustos -------------- */
function prepararOrden(num){
  menuDiv.style.display = 'none';
  ordenSalidaDiv.style.display = 'block';
  valeWrap.style.display = 'none';
  textoOrdenDiv.innerHTML = '<div>Calculando tiradas...</div>';

  const initial = [];
  for(let i=0;i<num;i++){
    initial.push({ jugador: i, resultado: lanzarDado() });
  }
  procesarResultsIterativo(initial);
}

function procesarResultsIterativo(results){
  let html = '<h3>Resultados</h3>';
  results.forEach(r=>{
    html += `<div class="jugador-turno" style="color:${colores[r.jugador]}">Jugador ${nombresColores[colores[r.jugador]]}: ${r.resultado}</div>`;
  });

  const map = {};
  results.forEach(r => {
    if (!map[r.resultado]) map[r.resultado] = [];
    map[r.resultado].push(r.jugador);
  });

  const duplicatesGroups = Object.values(map).filter(g => g.length > 1);

  if (duplicatesGroups.length === 0) {
    const finalOrder = [...results].sort((a,b)=>b.resultado - a.resultado).map(r=>r.jugador);
    ordenJugadores = finalOrder.slice();
    html += `<hr><strong>Orden de salida:</strong><div>${ordenJugadores.map(i=>`Jugador ${nombresColores[colores[i]]}`).join(' → ')}</div>`;
    textoOrdenDiv.innerHTML = html;
    valeWrap.style.display = 'flex';
    return;
  }

  html += `<p><strong>Empates detectados:</strong></p>`;
  duplicatesGroups.forEach(g => {
    html += `<div>Empate entre: ${g.map(i=>`${nombresColores[colores[i]]}`).join(', ')}</div>`;
  });

  textoOrdenDiv.innerHTML = html;

  setTimeout(()=>{
    const newResults = results.map(r => {
      const inDup = duplicatesGroups.some(g => g.includes(r.jugador));
      if (inDup) {
        return { jugador: r.jugador, resultado: lanzarDado() };
      } else {
        return r;
      }
    });
    procesarResultsIterativo(newResults);
  }, 1200);
}

function lanzarDado(){ return Math.floor(Math.random()*6)+1; }

function confirmarOrden(){
  if (!ordenJugadores || ordenJugadores.length===0) return;
  document.getElementById('ordenSalida').style.display = 'none';
  menuDiv.style.display = 'none';
  iniciarJuego(ordenJugadores);
}

/* --------------- Iniciar juego --------------- */
function iniciarJuego(orden){
  ordenJugadores = orden.slice();
  botonTirar.style.display = 'block';
  mensajesJuego.style.display = 'block';
  if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{});
  
  jugadores = [];
  const contenedor = document.getElementById('game-container');
  contenedor.querySelectorAll('.ficha').forEach(n => n.remove());
  ordenJugadores.forEach(id => {
    const el = document.createElement('div');
    el.className = 'ficha';
    el.style.background = colores[id];
    el.dataset.id = id;
    contenedor.appendChild(el);
    jugadores.push({ id:id, ficha:el, posicion:0, activo:true, seisConsecutivos: 0 }); // Inicializar contador de 6s
  });
  llegados = [];
  turnoActual = 0;
  currentTop = 0; clampAndApplyTop();
  currentTop = viewport.clientHeight - board.clientHeight;
  clampAndApplyTop();
  
  colocarFichas();
  mostrarMensaje(`Turno del jugador ${nombresColores[colores[jugadores[turnoActual].id]]}`, false, colores[jugadores[turnoActual].id]);
}

/* --------------- colocar fichas (muestra todas incluidas las llegadas) --------------- */
function colocarFichas(){
  const img = document.getElementById('board');
  const scale = img.clientWidth / diseñoOriginal.width;
  const ocupadas = {};
  jugadores.forEach(j => {
    const key = `c${j.posicion}`;
    if (!ocupadas[key]) ocupadas[key] = [];
    ocupadas[key].push(j);
  });
  for (const key in ocupadas){
    const grupo = ocupadas[key];
    const pos = parseInt(key.slice(1));
    const [xBase,yBase] = coords[pos];
    grupo.forEach((jugador,i)=>{
      const x = (xBase * scale);
      const y = (yBase * scale);
      const offsetAngle = (i % 4);
      const dx = ((offsetAngle === 0 || offsetAngle === 3) ? -12 : 12) + (Math.floor(i/4)*6);
      const dy = ((offsetAngle === 0 || offsetAngle === 1) ? -12 : 12) + (Math.floor(i/4)*6);
      jugador.ficha.style.left = `${x}px`;
      jugador.ficha.style.top  = `${y}px`;
      jugador.ficha.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    });
  }
}

/* --------------- Mensajes temporales --------------- */
function mostrarMensaje(texto, temporal = true, color = '#fff') {
    if (mensajeTimer) clearTimeout(mensajeTimer);
    mensajesJuego.innerHTML = texto;
    mensajesJuego.style.opacity = 1;
    mensajesJuego.style.color = color;
    if (temporal) {
        mensajeTimer = setTimeout(() => {
            mensajesJuego.style.opacity = 0;
        }, 4000);
    }
}

/* NUEVO: Función para mostrar texto de acción especial */
function mostrarTextoEspecial(texto, color = 'gold', duracion = 2500) {
    const contenedor = document.getElementById('viewport');
    const textoEl = document.createElement('div');
    textoEl.className = 'texto-especial';
    textoEl.textContent = texto;
    textoEl.style.color = color;
    contenedor.appendChild(textoEl);
    
    setTimeout(() => {
        textoEl.remove();
    }, duracion);
}

/* --------------- movimiento: tirar dado y reglas --------------- */
function simularTirada(){
  clearTimeout(mensajeTimer);
  mensajesJuego.style.opacity = 0;
  botonTirar.classList.add('animando');
  botonTirar.disabled = true;
  botonMusica.disabled = true;

  setTimeout(() => { botonTirar.classList.remove('animando'); }, 300);

  if (jugadores.length === 0) return;
  let attempts = 0;
  while (attempts < jugadores.length && !jugadores[turnoActual].activo){
    turnoActual = (turnoActual + 1) % jugadores.length;
    attempts++;
  }
  if (attempts >= jugadores.length) return;

  const jugador = jugadores[turnoActual];
  const colorJugador = colores[jugador.id];
  const nombreJugador = nombresColores[colorJugador];
  
  // Reproducir sonido de tirada de dado
  playSound(audioTiradaDado);

  // Mostrar el dado girando
  dadoContenedor.style.display = 'block';
  dadoElemento.classList.remove('girando-final-1', 'girando-final-2', 'girando-final-3', 'girando-final-4', 'girando-final-5', 'girando-final-6');
  dadoElemento.className = 'dado girando';
  
  // Retraso para que la animación de giro sea visible
  setTimeout(() => {
    const avance = lanzarDado();
    const posInicial = jugador.posicion;
    let posNueva = posInicial + avance;

    dadoElemento.classList.remove('girando');
    dadoElemento.classList.add(`girando-final-${avance}`);
    
    // Retraso para que el jugador vea el resultado del dado
    setTimeout(() => {
      dadoContenedor.style.display = 'none';

      let esSeis = false;
      // Lógica de los tres 6 seguidos
      if (avance === 6) {
          esSeis = true;
          playSound(audioDado6);
          jugador.seisConsecutivos++;
          let mensajeDado = '';
          if (jugador.seisConsecutivos === 1) {
              mensajeDado = `¡${nombreJugador} ha sacado un 6, vuelve a tirar!`;
          } else if (jugador.seisConsecutivos === 2) {
              mensajeDado = `¡${nombreJugador}, vuelve a tirar, pero cuidado!`;
          } else if (jugador.seisConsecutivos === 3) {
              mensajeDado = `¡${nombreJugador} se ha socarrado, a la casilla de salida!`;
              posNueva = 0;
              jugador.seisConsecutivos = 0;
          }
          mostrarTextoEspecial(mensajeDado, colorJugador, 2500);
      } else {
          jugador.seisConsecutivos = 0;
          mostrarMensaje(`Jugador ${nombreJugador} ha sacado un ${avance}.`, true, colorJugador);
      }
      
      animarMovimiento(jugador, posNueva >= 52 ? 52 : posNueva, () => {
        jugador.posicion = posNueva >= 52 ? 52 : posNueva;
        manejarCasillaEspecial(jugador, avance);
      });

    }, 2500);
  }, 1000);
}

// Función que maneja las casillas especiales después de mover
function manejarCasillaEspecial(jugador, avance){
  const posActual = jugador.posicion;
  const casillaEspecial = especiales[posActual];
  const colorJugador = colores[jugador.id];
  const nombreJugador = nombresColores[colorJugador];
  
  if (casillaEspecial) {
    const resplandorDiv = document.createElement('div');
    resplandorDiv.className = 'casilla-resplandor';
    
    let timeoutDuracion = 2000;
    let mensajeTextoEspecial = "";
    
    const posDestino = casillaEspecial.destino;

    if (casillaEspecial.tipo === 'gozer') {
      resplandorDiv.classList.add('brillo-gozer');
      timeoutDuracion = 3000;
      mensajeTextoEspecial = `¡${nombreJugador}, Gozer te ha mandado a la SALIDA!`;
      mostrarMensaje(`¡Ataque de Gozer! El jugador ${nombreJugador} vuelve a la salida.`, true, colorJugador);
      playSound(audioGozer);
    } else if (casillaEspecial.tipo === 'avance') {
      resplandorDiv.classList.add('brillo-verde');
      mensajeTextoEspecial = `¡${nombreJugador} sube de la casilla ${posActual} a la ${posDestino}!`;
      playRandomSound([audioSubida1, audioSubida2]);
    } else { // retroceso
      resplandorDiv.classList.add('brillo-rojo');
      mensajeTextoEspecial = `¡${nombreJugador} cae de la casilla ${posActual} a la ${posDestino}!`;
      playRandomSound([audioBajada1, audioBajada2]);
    }

    const [x,y] = coords[posActual];
    const scale = board.clientWidth / diseñoOriginal.width;
    resplandorDiv.style.left = `${x * scale}px`;
    resplandorDiv.style.top = `${y * scale}px`;
    gameContainer.appendChild(resplandorDiv);
    
    if (mensajeTextoEspecial) mostrarTextoEspecial(mensajeTextoEspecial, colorJugador);

    setTimeout(() => {
      resplandorDiv.remove();
      const posFinalEspecial = casillaEspecial.destino;
      animarMovimiento(jugador, posFinalEspecial, () => {
        jugador.posicion = posFinalEspecial;
        finalizarTurno(jugador, avance);
      });
    }, timeoutDuracion);

  } else {
    // Si no es una casilla especial, finalizar el turno
    finalizarTurno(jugador, avance);
  }
}

// Función que maneja el movimiento visual de la ficha
function animarMovimiento(jugador, posDestino, callback) {
    const scale = board.clientWidth / diseñoOriginal.width;
    const [x, y] = coords[posDestino];

    jugador.ficha.classList.add('ficha-levantada');

    jugador.ficha.style.left = `${x * scale}px`;
    jugador.ficha.style.top = `${y * scale}px`;
    
    centrarSiEsNecesario(jugador);

    setTimeout(() => {
        jugador.ficha.classList.remove('ficha-levantada');
        callback();
    }, 500);
}

function finalizarTurno(jugador, ultimoAvance) {
  const nombreJugador = nombresColores[colores[jugador.id]];
  const colorJugador = colores[jugador.id];

  if (jugador.posicion >= 52) {
    if (jugador.posicion > 52) jugador.posicion = 52;
    jugador.activo = false;
    if (!llegados.includes(jugador.id)) {
        llegados.push(jugador.id);
        mostrarTextoEspecial(`¡${nombreJugador} ha llegado a la meta!`, colorJugador, 3000);
        if (llegados.length === 1) {
            animarGanador(jugador);
        }
    }
  }

  colocarFichas();

  // Comprobar si la partida ha terminado antes de cambiar de turno.
  // El juego termina si todos los jugadores han llegado a la meta.
  // También termina si en un juego de más de un jugador, solo queda una ficha activa.
  const jugadoresActivos = jugadores.filter(j => j.activo).length;
  if (llegados.length === ordenJugadores.length || (ordenJugadores.length > 1 && jugadoresActivos <= 1)) {
    // Los jugadores que quedan activos (si los hay) se añaden a la lista de "llegados" en último lugar.
    jugadores.filter(j=>j.activo).forEach(j => { if (!llegados.includes(j.id)) llegados.push(j.id); });
    
    // CORRECCIÓN: Re-activar los botones antes de mostrar el final del juego
    botonTirar.disabled = false;
    botonMusica.disabled = false;

    mostrarFinal();
    botonTirar.style.display = 'none'; // Se oculta el botón de tirar porque la partida ha terminado
    return; // Salir de la función para no intentar cambiar de turno
  }
  
  if (ultimoAvance !== 6 || jugador.seisConsecutivos === 3) {
    mostrarMensaje(`Jugador ${nombresColores[colores[jugador.id]]} en casilla ${jugador.posicion}.`, true, colorJugador);
    // Bucle para encontrar el siguiente jugador activo
    let proximoTurno = turnoActual;
    do {
      proximoTurno = (proximoTurno + 1) % jugadores.length;
    } while (!jugadores[proximoTurno].activo);
    turnoActual = proximoTurno;
    
    setTimeout(() => {
      botonTirar.disabled = false;
      botonMusica.disabled = false;
      const proximoJugador = jugadores[turnoActual];
      mostrarMensaje(`Turno del jugador ${nombresColores[colores[proximoJugador.id]]}`, false, colores[proximoJugador.id]);
    }, 2000);

  } else {
    // Si sacó 6 y no es el tercero, su turno continúa
    setTimeout(() => {
      botonTirar.disabled = false;
      botonMusica.disabled = false;
    }, 2000);
  }
}


/* --------------- animación ganador --------------- */
function animarGanador(jugador){
  playSound(audioLlegadaMeta);
  jugador.ficha.classList.add('brillo');
  const img = document.getElementById('board');
  const scale = img.clientWidth / diseñoOriginal.width;
  const [xBase,yBase] = coords[jugador.posicion];
  const x = xBase * scale;
  const y = yBase * scale;

  const texto = document.createElement('div');
  texto.className = 'texto-flotante';
  texto.textContent = '¡Primer puesto!';
  texto.style.left = `${x}px`;
  texto.style.top  = `${y - 20}px`;
  document.getElementById('game-container').appendChild(texto);

  setTimeout(()=>{
    texto.remove();
    jugador.ficha.classList.remove('brillo');
  }, 3000);
}

/* --------------- mostrar final (modal con puestos) --------------- */
function mostrarFinal(){
  const modal = document.getElementById('finalModal');
  let html = '<h3>Clasificación final</h3>';
  llegados.forEach((id,idx)=>{
    html += `<div style="color:${colores[id]}">${idx+1}º - Jugador ${nombresColores[colores[id]]}</div>`;
  });
  // El botón ahora llama a una nueva función `reiniciarJuego`
  html += `<div style="margin-top:14px"><button onclick="reiniciarJuego()">Jugar de nuevo</button></div>`;
  modal.innerHTML = html;
  modal.style.display = 'block';
}

// Nuevo: Función para reiniciar el juego sin recargar la página
function reiniciarJuego() {
    finalModal.style.display = 'none';
    startMenuDiv.style.display = 'none'; // ocultamos el menu de inicio
    menuDiv.style.display = 'block'; // mostramos el menu de seleccion de jugadores
    botonTirar.style.display = 'none';
    mensajesJuego.style.display = 'none';

    // Restablecer el estado del juego
    jugadores = [];
    ordenJugadores = [];
    turnoActual = 0;
    llegados = [];

    // Eliminar las fichas del tablero
    const contenedor = document.getElementById('game-container');
    contenedor.querySelectorAll('.ficha').forEach(n => n.remove());

    // Volver a reproducir la musica si estaba activada
    if (isMusicEnabled) {
      audioMusicaInicio.currentTime = 0;
      audioMusicaInicio.play();
    }
}


/* --------------- centrado vertical si la ficha queda fuera --------------- */
function centrarSiEsNecesario(jugador){
  const img = document.getElementById('board');
  const scale = img.clientWidth / diseñoOriginal.width;
  const [xBase,yBase] = coords[jugador.posicion];
  const yPixel = yBase * scale;
  const boardHeight = img.clientHeight;
  const maxTop = 0;
  const minTop = viewport.clientHeight - boardHeight;
  const fichaYvisible = yPixel + currentTop;
  
  if (fichaYvisible < 0 || fichaYvisible > viewport.clientHeight){
    let nuevoTop = Math.round(viewport.clientHeight/2 - yPixel);
    if (minTop > 0) nuevoTop = 0;
    nuevoTop = Math.min(maxTop, Math.max(minTop, nuevoTop));
    currentTop = nuevoTop;
    gameContainer.style.top = `${currentTop}px`;
  }
}

/* --------------- onload / resize: recolocar fichas si es necesario --------------- */
window.addEventListener('load', ()=>{
  currentTop = 0; clampAndApplyTop();
  // Configurar volumen de la música de inicio
  audioMusicaInicio.volume = 0.1;
  // Configurar estado inicial del botón de música
  botonMusica.innerHTML = isMusicEnabled ? '&#128266;' : '&#128263;';
});
window.addEventListener('resize', ()=>{
  clampAndApplyTop();
  colocarFichas();
});
</script>
</body>
</html>